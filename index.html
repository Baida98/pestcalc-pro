<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PestCalc Pro</title>
  <style>
    /* Stile originale preservato */
    body {
      font-family: sans-serif;
      margin: 0;
      background: #f9f9f9;
      color: #333;
    }
    .app-container {
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }
    header, section {
      margin-bottom: 30px;
    }
    h1, h2 {
      color: #4a63e7;
    }
    input, select {
      display: block;
      margin: 10px 0;
      padding: 10px;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button {
      background-color: #4a63e7;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 4px;
      width: 100%;
      font-weight: bold;
    }
    button:hover {
      background-color: #3547c1;
    }
    .output {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      background: #f0f4ff;
      font-weight: bold;
    }
    .error {
      background: #ffebee;
      color: #c62828;
    }
    .success {
      background: #e8f5e9;
      color: #2e7d32;
    }
    footer {
      text-align: center;
      font-size: 0.9em;
      color: #888;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    .product-item {
      padding: 10px;
      margin-bottom: 10px;
      background: white;
      border-radius: 4px;
      border: 1px solid #eee;
    }
    .history-item {
      padding: 8px;
      margin-bottom: 5px;
      background: #f8f8f8;
      border-left: 3px solid #4a63e7;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header>
      <h1>PestCalc Pro</h1>
      <p>Calcolatore professionale per disinfestatori</p>
    </header>

    <!-- Sezione Calcolo Diluizione -->
    <section id="diluizione">
      <h2>üíß Calcolo Diluizione</h2>
      <input type="number" id="concentrazione" placeholder="% principio attivo" min="0.1" max="100" step="0.1">
      <input type="number" id="volume" placeholder="Volume soluzione finale (ml)" min="10" step="1">
      <button onclick="calcolaDiluizione()">Calcola</button>
      <div id="output-diluizione" class="output"></div>
    </section>

    <!-- Sezione Saturazione Ambientale -->
    <section id="saturazione">
      <h2>üè† Saturazione Ambientale</h2>
      <input type="number" id="mq" placeholder="Metri quadri" min="1" step="0.1">
      <input type="number" id="dose" placeholder="ml/mq" min="1" step="1">
      <button onclick="calcolaSaturazione()">Calcola</button>
      <div id="output-saturazione" class="output"></div>
    </section>

    <!-- Sezione Fumigazione -->
    <section id="fumigazione">
      <h2>‚òÅÔ∏è Fumigazione</h2>
      <input type="number" id="mc" placeholder="Metri cubi" min="1" step="1">
      <input type="number" id="dose-fumo" placeholder="ml/mc" min="1" step="1">
      <button onclick="calcolaFumigazione()">Calcola</button>
      <div id="output-fumigazione" class="output"></div>
    </section>

    <!-- Sezione Calcolo Costi -->
    <section id="costi">
      <h2>üí∞ Calcolo Costi</h2>
      <input type="number" id="prezzo" placeholder="Prezzo per litro (‚Ç¨)" min="0" step="0.01">
      <input type="number" id="mlusati" placeholder="ml usati" min="1" step="1">
      <input type="number" id="manodopera" placeholder="Costo manodopera (‚Ç¨/ora)" min="0" step="1">
      <input type="number" id="tempo" placeholder="Tempo stimato (ore)" min="0.1" step="0.1">
      <button onclick="calcolaCosti()">Calcola</button>
      <div id="output-costi" class="output"></div>
    </section>

    <!-- Sezione Gestione Prodotti -->
    <section id="prodotti">
      <h2>üß™ Gestione Prodotti</h2>
      <input type="text" id="nome-prodotto" placeholder="Nome Prodotto">
      <input type="number" id="concentrazione-prodotto" placeholder="Concentrazione PA (%)" min="0.1" max="100" step="0.1">
      <input type="number" id="prezzo-prodotto" placeholder="Prezzo al litro (‚Ç¨)" min="0.01" step="0.01">
      <input type="number" id="tempo-azione" placeholder="Tempo di azione (ore)" min="0.1" step="0.1">
      <select id="tipo-prodotto">
        <option value="">Seleziona tipo prodotto</option>
        <option value="insetticida">Insetticida</option>
        <option value="rodenticida">Rodenticida</option>
        <option value="fumigante">Fumigante</option>
        <option value="altro">Altro</option>
      </select>
      <button onclick="aggiungiProdotto()">Aggiungi Prodotto</button>
      <div id="output-prodotto" class="output"></div>
      <div id="lista-prodotti"></div>
    </section>

    <!-- Sezione Storico Calcoli -->
    <section id="storico">
      <h2>üìö Storico Calcoli</h2>
      <button onclick="mostraStorico()">Carica Storico</button>
      <div id="lista-storico" class="output"></div>
    </section>

    <footer>
      <p>¬© 2025 PestCalc Pro. Tutti i diritti riservati.</p>
      <p>Versione 4.0 | Dominio: baida98.github.io</p>
    </footer>
  </div>

  <script>
    // ========== SISTEMA DI LOGGING AVANZATO ========== //
    const Logger = {
      log: (message, type = 'INFO') => {
        const timestamp = new Date().toISOString().slice(11, 19);
        console.log(`[${timestamp}] [${type}] ${message}`);
      },
      error: (message) => Logger.log(message, 'ERROR'),
      warn: (message) => Logger.log(message, 'WARN'),
      debug: (message) => Logger.log(message, 'DEBUG')
    };

    // ========== GESTIONE ERRORI STRUTTURATA ========== //
    class AppError extends Error {
      constructor(message, context) {
        super(message);
        this.name = "AppError";
        this.context = context;
        Logger.error(`[${context}] ${message}`);
      }
    }

    // ========== UTILITIES AVANZATE ========== //
    const Utils = {
      parseInput: (id, options = {}) => {
        const element = document.getElementById(id);
        if (!element) {
          throw new AppError(`Elemento non trovato: ${id}`, 'Utils.parseInput');
        }
        
        const value = element.value.trim();
        if (value === '') {
          if (options.required) throw new AppError(`Il campo √® obbligatorio`, id);
          return options.defaultValue || null;
        }
        
        // Gestione speciale per campi numerici
        if (element.type === 'number') {
          const numValue = parseFloat(value);
          if (isNaN(numValue)) throw new AppError(`Valore numerico non valido`, id);
          
          if (options.min !== undefined && numValue < options.min) {
            throw new AppError(`Il valore non pu√≤ essere inferiore a ${options.min}`, id);
          }
          
          if (options.max !== undefined && numValue > options.max) {
            throw new AppError(`Il valore non pu√≤ superare ${options.max}`, id);
          }
          
          return numValue;
        }
        
        return value;
      },
      
      displayResult: (id, message, isError = false) => {
        const output = document.getElementById(id);
        if (output) {
          output.textContent = message;
          output.className = `output ${isError ? 'error' : 'success'}`;
        }
      },
      
      saveData: (key, data) => {
        try {
          localStorage.setItem(`pestcalc_${key}`, JSON.stringify(data));
          Logger.debug(`Dati salvati per chiave: ${key}`);
        } catch (e) {
          throw new AppError(`Errore nel salvataggio dati: ${e.message}`, 'Utils.saveData');
        }
      },
      
      loadData: (key) => {
        try {
          const data = localStorage.getItem(`pestcalc_${key}`);
          return data ? JSON.parse(data) : null;
        } catch (e) {
          throw new AppError(`Errore nel caricamento dati: ${e.message}`, 'Utils.loadData');
        }
      },
      
      formatCurrency: (value) => {
        return `‚Ç¨${value.toFixed(2).replace('.', ',')}`;
      },
      
      formatVolume: (value) => {
        return value >= 1000 ? `${(value/1000).toFixed(2)} L` : `${value.toFixed(1)} ml`;
      }
    };

    // ========== GESTIONE PRODOTTI ========== //
    const ProductManager = {
      addProduct: (product) => {
        try {
          const products = ProductManager.getProducts() || [];
          product.id = Date.now();
          product.createdAt = new Date().toISOString();
          products.push(product);
          Utils.saveData('products', products);
          Logger.log(`Prodotto aggiunto: ${product.nome}`);
          return product;
        } catch (e) {
          throw new AppError(`Errore aggiunta prodotto: ${e.message}`, 'ProductManager.addProduct');
        }
      },
      
      getProducts: () => {
        return Utils.loadData('products') || [];
      },
      
      deleteProduct: (id) => {
        try {
          const products = ProductManager.getProducts();
          const newProducts = products.filter(p => p.id !== id);
          Utils.saveData('products', newProducts);
          Logger.log(`Prodotto eliminato: ${id}`);
          return true;
        } catch (e) {
          throw new AppError(`Errore eliminazione prodotto: ${e.message}`, 'ProductManager.deleteProduct');
        }
      },
      
      renderProducts: () => {
        const container = document.getElementById('lista-prodotti');
        if (!container) return;
        
        const products = ProductManager.getProducts();
        container.innerHTML = '';
        
        if (products.length === 0) {
          container.innerHTML = '<p>Nessun prodotto salvato</p>';
          return;
        }
        
        products.forEach(product => {
          const div = document.createElement('div');
          div.className = 'product-item';
          div.innerHTML = `
            <strong>${product.nome}</strong> (${product.tipoProdotto})<br>
            PA: ${product.concentrazione}% | Prezzo: ${Utils.formatCurrency(product.prezzo)}/L<br>
            Azione: ${product.tempoAzione}h
            <button onclick="eliminaProdotto(${product.id})">Elimina</button>
          `;
          container.appendChild(div);
        });
      }
    };

    // ========== GESTIONE STORICO ========== //
    const HistoryManager = {
      addRecord: (operation, data) => {
        try {
          const history = HistoryManager.getHistory() || [];
          history.unshift({
            timestamp: new Date().toISOString(),
            operation,
            data
          });
          
          // Mantieni solo gli ultimi 50 record
          if (history.length > 50) history.pop();
          
          Utils.saveData('history', history);
          Logger.debug(`Record storico aggiunto: ${operation}`);
        } catch (e) {
          throw new AppError(`Errore aggiunta storico: ${e.message}`, 'HistoryManager.addRecord');
        }
      },
      
      getHistory: () => {
        return Utils.loadData('history') || [];
      },
      
      clearHistory: () => {
        Utils.saveData('history', []);
        Logger.log('Storico cancellato');
      },
      
      renderHistory: () => {
        const container = document.getElementById('lista-storico');
        if (!container) return;
        
        const history = HistoryManager.getHistory();
        container.innerHTML = '';
        
        if (history.length === 0) {
          container.innerHTML = '<p>Nessun record nello storico</p>';
          return;
        }
        
        history.forEach(record => {
          const div = document.createElement('div');
          div.className = 'history-item';
          
          const date = new Date(record.timestamp).toLocaleString();
          let content = `[${date}] ${record.operation.toUpperCase()}: `;
          
          switch(record.operation) {
            case 'diluizione':
              content += `PA ${record.data.concentrazione}% in ${Utils.formatVolume(record.data.volume)}`;
              break;
            case 'saturazione':
              content += `${record.data.mq} m¬≤ √ó ${record.data.dose} ml/m¬≤`;
              break;
            case 'fumigazione':
              content += `${record.data.mc} m¬≥ √ó ${record.data.doseFumo} ml/m¬≥`;
              break;
            case 'costi':
              content += `${Utils.formatVolume(record.data.mlusati)} a ${Utils.formatCurrency(record.data.prezzo)}/L`;
              break;
            case 'prodotto':
              content += `Aggiunto ${record.data.nome}`;
              break;
          }
          
          div.textContent = content;
          container.appendChild(div);
        });
      }
    };

    // ========== FUNZIONI DI CALCOLO ========== //
    function calcolaDiluizione() {
      try {
        Logger.debug('Avvio calcolo diluizione');
        
        const concentrazione = Utils.parseInput('concentrazione', {
          required: true,
          min: 0.1,
          max: 100
        });
        
        const volume = Utils.parseInput('volume', {
          required: true,
          min: 10,
          max: 10000
        });
        
        const mlPrincipioAttivo = (concentrazione / 100) * volume;
        const mlSolvente = volume - mlPrincipioAttivo;
        
        const result = `Principio attivo: ${Utils.formatVolume(mlPrincipioAttivo)}
Solvente: ${Utils.formatVolume(mlSolvente)}
Totale: ${Utils.formatVolume(volume)}`;
        
        Utils.displayResult('output-diluizione', result);
        HistoryManager.addRecord('diluizione', { concentrazione, volume });
        
      } catch (error) {
        Utils.displayResult('output-diluizione', `ERRORE: ${error.message}`, true);
      }
    }

    function calcolaSaturazione() {
      try {
        Logger.debug('Avvio calcolo saturazione');
        
        const mq = Utils.parseInput('mq', {
          required: true,
          min: 1,
          max: 10000
        });
        
        const dose = Utils.parseInput('dose', {
          required: true,
          min: 1,
          max: 1000
        });
        
        const mlTotali = mq * dose;
        const result = `Prodotto necessario: ${Utils.formatVolume(mlTotali)}
Per ${mq} m¬≤ a ${dose} ml/m¬≤`;
        
        Utils.displayResult('output-saturazione', result);
        HistoryManager.addRecord('saturazione', { mq, dose });
        
      } catch (error) {
        Utils.displayResult('output-saturazione', `ERRORE: ${error.message}`, true);
      }
    }

    function calcolaFumigazione() {
      try {
        Logger.debug('Avvio calcolo fumigazione');
        
        const mc = Utils.parseInput('mc', {
          required: true,
          min: 1,
          max: 100000
        });
        
        const doseFumo = Utils.parseInput('dose-fumo', {
          required: true,
          min: 1,
          max: 500
        });
        
        const mlTotali = mc * doseFumo;
        const result = `Fumigante necessario: ${Utils.formatVolume(mlTotali)}
Per ${mc} m¬≥ a ${doseFumo} ml/m¬≥`;
        
        Utils.displayResult('output-fumigazione', result);
        HistoryManager.addRecord('fumigazione', { mc, doseFumo });
        
      } catch (error) {
        Utils.displayResult('output-fumigazione', `ERRORE: ${error.message}`, true);
      }
    }

    function calcolaCosti() {
      try {
        Logger.debug('Avvio calcolo costi');
        
        const prezzo = Utils.parseInput('prezzo', {
          required: true,
          min: 0.01,
          max: 10000
        });
        
        const mlusati = Utils.parseInput('mlusati', {
          required: true,
          min: 1,
          max: 100000
        });
        
        const manodopera = Utils.parseInput('manodopera', {
          min: 0,
          max: 200,
          defaultValue: 0
        });
        
        const tempo = Utils.parseInput('tempo', {
          min: 0.1,
          max: 24,
          defaultValue: 0
        });
        
        const costoProdotto = (prezzo / 1000) * mlusati;
        const costoManodopera = manodopera * tempo;
        const costoTotale = costoProdotto + costoManodopera;
        
        let result = `Costo prodotto: ${Utils.formatCurrency(costoProdotto)}`;
        
        if (manodopera > 0 && tempo > 0) {
          result += `\nManodopera: ${Utils.formatCurrency(costoManodopera)} (${tempo}h √ó ${Utils.formatCurrency(manodopera)}/h)`;
          result += `\nCosto totale: ${Utils.formatCurrency(costoTotale)}`;
        }
        
        Utils.displayResult('output-costi', result);
        HistoryManager.addRecord('costi', { prezzo, mlusati, manodopera, tempo });
        
      } catch (error) {
        Utils.displayResult('output-costi', `ERRORE: ${error.message}`, true);
      }
    }

    // ========== GESTIONE PRODOTTI (UI) ========== //
    function aggiungiProdotto() {
      try {
        Logger.debug('Aggiunta nuovo prodotto');
        
        const nome = Utils.parseInput('nome-prodotto', { required: true });
        const concentrazione = Utils.parseInput('concentrazione-prodotto', {
          required: true,
          min: 0.1,
          max: 100
        });
        
        const prezzo = Utils.parseInput('prezzo-prodotto', {
          required: true,
          min: 0.01,
          max: 10000
        });
        
        const tempoAzione = Utils.parseInput('tempo-azione', {
          required: true,
          min: 0.1,
          max: 100
        });
        
        const tipoProdotto = Utils.parseInput('tipo-prodotto', { required: true });
        
        const product = {
          nome,
          concentrazione,
          prezzo,
          tempoAzione,
          tipoProdotto
        };
        
        ProductManager.addProduct(product);
        Utils.displayResult('output-prodotto', `‚úÖ Prodotto "${nome}" aggiunto con successo!`);
        ProductManager.renderProducts();
        HistoryManager.addRecord('prodotto', product);
        
        // Reset form
        document.getElementById('nome-prodotto').value = '';
        document.getElementById('concentrazione-prodotto').value = '';
        document.getElementById('prezzo-prodotto').value = '';
        document.getElementById('tempo-azione').value = '';
        document.getElementById('tipo-prodotto').value = '';
        
      } catch (error) {
        Utils.displayResult('output-prodotto', `ERRORE: ${error.message}`, true);
      }
    }

    function eliminaProdotto(id) {
      try {
        if (confirm('Sei sicuro di voler eliminare questo prodotto?')) {
          ProductManager.deleteProduct(id);
          ProductManager.renderProducts();
          Utils.displayResult('output-prodotto', 'Prodotto eliminato con successo');
        }
      } catch (error) {
        Utils.displayResult('output-prodotto', `ERRORE: ${error.message}`, true);
      }
    }

    function mostraStorico() {
      try {
        HistoryManager.renderHistory();
        Logger.debug('Storico calcoli caricato');
      } catch (error) {
        Utils.displayResult('lista-storico', `ERRORE: ${error.message}`, true);
      }
    }

    // ========== INIZIALIZZAZIONE ========== //
    document.addEventListener('DOMContentLoaded', () => {
      Logger.log('Applicazione PestCalc Pro inizializzata');
      
      // Carica prodotti
      ProductManager.renderProducts();
      
      // Carica storico
      HistoryManager.renderHistory();
      
      // Imposta valori di esempio per test
      if (!Utils.loadData('products')) {
        Logger.debug('Impostazione dati demo');
        ProductManager.addProduct({
          nome: "Insetticida X200",
          concentrazione: 10,
          prezzo: 25.99,
          tempoAzione: 4,
          tipoProdotto: "insetticida"
        });
      }
    });
  </script>
</body>
</html>
